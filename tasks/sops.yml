version: '3'

tasks:
  update:
    desc: "Update SOPS keys for all encrypted files"
    cmds:
      - |
        echo "ğŸ”‘ Updating SOPS keys for all encrypted files..."

        yq eval '.creation_rules[].path_regex' .sops.yaml | while read -r pattern; do
          if [ -n "$pattern" ]; then
            search_pattern=$(echo "$pattern" | sed 's/\^//g' | sed 's/\$//g' | sed 's/\.ya?ml\$/\.yaml/g' | sed 's/\.ya?ml\$/\.yml/g')

            echo "ğŸ“ Searching for files matching: $pattern"

            find . -type f \( -name "*.yaml" -o -name "*.yml" \) | grep -E "$pattern" | while read -r file; do
              if [ -f "$file" ]; then
                echo "  ğŸ”„ Updating: $file"
                sops updatekeys -y "$file" || echo "  âš ï¸  Failed to update: $file"
              fi
            done
          fi
        done

        echo "âœ… SOPS key update complete!"
